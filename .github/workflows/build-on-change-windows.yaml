name: Build framework on Windows

on:
  # execute on every PR made targeting the branches bellow
  pull_request:
    branches:
      - main
    paths: # we only include paths critical for building to avoid unnecessary runs
      - src/**
      - include/**
      - scripts/cmake/**
      - test/**
      - .github/workflows/**
      - doc/**
      - qc_framework/**
      - docker/**

  # execute on every push made targeting the branches bellow
  push:
    branches:
      - main
    paths: # we only include paths critical for building to avoid unnecessary runs
      - src/**
      - include/**
      - scripts/cmake/**
      - test/**
      - .github/workflows/**
      - doc/**
      - qc_framework/**
      - docker/**

  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  build-windows:
    runs-on: windows-2022
    env:
      TEST_ENABLED: ${{ github.event_name == 'pull_request' && 'ON' || 'OFF' }}
      WORKING_PATH: "D:\\a"
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get CMake
        uses: lukka/get-cmake@latest

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: "bffcbb75f71553824aa948a7e7b4f798662a6fa7"

      - name: Build framework
        uses: lukka/run-cmake@v10
        with:
          configurePreset: vcpkg
          buildPreset: vcpkg
          buildPresetAdditionalArgs: "['--config Release']"

      - name: Archive release binaries
        run: |
          mkdir artifacts
          copy .\build\src\result_pooling\Release\ResultPooling.exe .\artifacts\
          copy .\build\src\report_modules\report_module_text\Release\TextReport.exe .\artifacts\
          copy .\build\src\report_modules\report_module_github_ci\Release\GithubCIReport.exe .\artifacts\
          copy .\build\src\report_modules\report_module_gui\Release\ReportGUI.exe .\artifacts\
        shell: cmd

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qc-framework-executables-windows
          path: artifacts

      - name: Unit test execution
        run: |
          Write-Output "Starting unit tests..."

          cd "$env:WORKING_PATH\qc-framework\qc-framework"

          ctest --test-dir build -C Release

          Write-Output "All unit tests done."
        shell: pwsh

      - name: Archive test results
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: ${{ github.workspace }}\build\Testing\Temporary\LastTest.log

      - name: Framework test execution
        run: |
          Write-Output "Starting framework tests..."

          Rename-Item -path "$env:WORKING_PATH\qc-framework\qc-framework\build" -NewName "$env:WORKING_PATH\qc-framework\qc-framework\out_build"
          Copy-Item -Path "$env:WORKING_PATH\QC-Framework-Out\bin" -Destination "$env:WORKING_PATH\qc-framework\qc-framework\bin" -Recurse
          Copy-Item -Path "$env:WORKING_PATH\qc-framework\qc-framework\out_build\examples\checker_bundle_example\Release\DemoCheckerBundle.exe" -Destination "$env:WORKING_PATH\qc-framework\qc-framework\bin"

          cd "$env:WORKING_PATH\qc-framework\qc-framework\qc_framework"
          python3 -m pip install poetry
          python3 -m poetry install
          python3 -m poetry run pytest
          Write-Output "All framework tests done."
        shell: pwsh

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Execute checker bundles
        run: |
          $env:ASAM_QC_FRAMEWORK_MANIFEST_DIR="$env:WORKING_PATH\qc-framework\qc-framework\.github\workflows\windows-manifest"
          $env:ASAM_QC_FRAMEWORK_INSTALLATION_DIR="$env:WORKING_PATH\QC-Framework-Out\bin"

          git config --system core.longpaths true

          pip install -e $env:WORKING_PATH\qc-framework\qc-framework\qc_framework

          mkdir "$env:WORKING_PATH\odr_out"
          pip install asam-qc-opendrive
          qc_runtime --config="$env:WORKING_PATH\qc-framework\qc-framework\.github\workflows\windows-files\odr_config.xml" --manifest="$env:WORKING_PATH\qc-framework\qc-framework\.github\workflows\windows-manifest\framework.json" --working_dir="$env:WORKING_PATH\odr_out"
          if (-not (Test-Path "$env:WORKING_PATH\odr_out\xodr_bundle_report.xqar")) { Throw "Error: Odr output does not exist." }
          if (-not (Test-Path "$env:WORKING_PATH\odr_out\Result.xqar")) { Throw "Error: Odr output does not exist." }
          if (-not (Test-Path "$env:WORKING_PATH\odr_out\Report.txt")) { Throw "Error: Odr output does not exist." }

          mkdir "$env:WORKING_PATH\osc_out"
          pip install asam-qc-openscenarioxml
          qc_runtime --config="$env:WORKING_PATH\qc-framework\qc-framework\.github\workflows\windows-files\osc_config.xml" --manifest="$env:WORKING_PATH\qc-framework\qc-framework\.github\workflows\windows-manifest\framework.json" --working_dir="$env:WORKING_PATH\osc_out"
          if (-not (Test-Path "$env:WORKING_PATH\osc_out\xosc_bundle_report.xqar")) { Throw "Error: Osc output does not exist." }
          if (-not (Test-Path "$env:WORKING_PATH\osc_out\Result.xqar")) { Throw "Error: Osc output does not exist." }
          if (-not (Test-Path "$env:WORKING_PATH\osc_out\Report.txt")) { Throw "Error: Odr output does not exist." }

          mkdir "$env:WORKING_PATH\otx_out"
          pip install asam-qc-otx
          qc_runtime --config="$env:WORKING_PATH\qc-framework\qc-framework\.github\workflows\windows-files\otx_config.xml" --manifest="$env:WORKING_PATH\qc-framework\qc-framework\.github\workflows\windows-manifest\framework.json" --working_dir="$env:WORKING_PATH\otx_out"
          if (-not (Test-Path "$env:WORKING_PATH\otx_out\otx_bundle_report.xqar")) { Throw "Error: Otx output does not exist." }
          if (-not (Test-Path "$env:WORKING_PATH\otx_out\Result.xqar")) { Throw "Error: Otx output does not exist." }
          if (-not (Test-Path "$env:WORKING_PATH\otx_out\Report.txt")) { Throw "Error: Odr output does not exist." }

        shell: pwsh
